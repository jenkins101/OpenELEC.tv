#!/bin/sh


if [ -f /sys/class/mmc_host/mmc0/mmc0\:0001/mmc0\:0001\:1/device ] ;then
  chip=`cat /sys/class/mmc_host/mmc0/mmc0\:0001/mmc0\:0001\:1/device`
else
  # just exit if unsupported platform.
  exit 0
fi

HCD=""
EXTRA=""

if [ "$chip" = "0x4329" ] ; then
  HCD="bcm4329.hcd"
elif [ "$chip" = "0x4330" ] ; then
  HCD="bcm4330.hcd"
  EXTRA="--no2bytes --tosleep=50000 "
else
  echo "chip $chip not supported."
  exit 0                                 
fi

[ "$DEBUG" = "yes" ] && EXTRA="-d $EXTRA"

echo "Found chip $chip."
modprobe hci_uart
sleep 2
/usr/bin/brcm_patchram_plus --patchram /lib/firmware/brcm/$HCD --baudrate 3000000 --use_baudrate_for_download /dev/ttymxc3 --enable_hci $EXTRA &

for i in 1 2 3 4 5 ; do
  b=`hciconfig | grep UART | cut -d: -f1`
  if [ -n "$b" ] ; then
    hciconfig $b up 
    break
  else 
    sleep $i
  fi
done

exit 0
